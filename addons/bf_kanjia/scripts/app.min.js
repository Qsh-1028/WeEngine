var app = angular.module("app", ["infinite-scroll", "ngSanitize", "oitozero.ngSweetAlert", "timer"]);
app.controller("pageloadController", ["$scope",
function(t) {
    t.dohide = false;
    t.$on("pageload-hide",
    function(e, o) {
        t.dohide = o
    })
}]);
app.run(["$templateCache",
function(t) {
    t.put("qrcode.html", "<div class='container' ng-class='{hide : code == 0}'><div class='row'><div class='col'><div class='box'><div class='box-header text-center'><div class='title'>二维码凭证</div></div><div class='box-content text-center'><p><img class='block' alt=' ' ng-src='{{qrcode}}' width='60%' style='margin:0 auto;'/></p><div style='color:#9D9C9C;'>将二维码展示给工作人员扫描</div></div></div></div></div></div>")
}]);
app.directive("qrcode", ["$http",
function(t) {
    return {
        restrict: "E",
        templateUrl: "qrcode.html",
        replace: true,
        scope: {
            code: "=dataCode",
            qrcode: "=dataQrcode"
        },
        link: function(e, o, r) {
            t.post(KANJIA_QRCODE_URL, {
                rid: KANJIA_RECORD_ID
            }).then(function(t) {
                e.qrcode = t.data.qrcode;
                e.code = t.data.code
            })
        }
    }
}]);
app.factory("TabData",
function() {
    var t = {
        op: "normal",
        tabs: [{
            name: "即将开始",
            op: "begin"
        },
        {
            name: "进行中",
            op: "normal"
        },
        {
            name: "往期",
            op: "past"
        }]
    };
    return t
});
app.controller("tabController", ["$scope", "TabData",
function(t, e) {
    t.op = e.op;
    t.tabs = e.tabs;
    t.tabclick = function(o) {
        t.op = o.op;
        e.op = o.op
    }
}]);
app.factory("Reddit", ["$rootScope", "$http", "TabData",
function(t, e, o) {
    var r = function() {
        this.items = [];
        this.load = false;
        this.page = 1;
        this.last = false
    };
    r.prototype.nextPage = function() {
        if (this.load || this.last) return;
        this.load = true;
        var r = LIST_URL;
        e.post(r, {
            page: this.page,
            op: o.op
        }).success(function(e) {
            for (var o = 0; o < e.length; o++) {
                this.items.push(e[o])
            }
            this.page += 1;
            this.load = false;
            if (e.length <= 0) {
                this.last = true
            }
            t.$broadcast("pageload-hide", true)
        }.bind(this))
    };
    return r
}]);
app.controller("scrollController", ["$scope", "Reddit", "TabData",
function(t, e, o) {
    t.op = "normal";
    t.reddit = new e;
    t.$watch(function() {
        return o.op
    },
    function(e, r) {
        if (e != r) {
            t.reddit.items = [];
            t.reddit.load = false;
            t.reddit.page = 1;
            t.reddit.last = false;
            t.reddit.nextPage();
            t.op = o.op
        }
    })
}]);
app.factory("Kanjia", ["$rootScope", "$http",
function(t, e) {
    var o = function() {
        this.obj = {};
        this.shownotice = false
    };
    o.prototype.loaddetail = function() {
        var o = KANJIA_DETAIL_URL;
        e.get(o).success(function(e) {
            this.obj = e;
            t.$broadcast("pageload-hide", true)
        }.bind(this))
    };
    o.prototype.showNotice = function() {
        this.shownotice = true
    };
    o.prototype.HideNotice = function() {
        this.shownotice = false
    };
    return o
}]);
app.controller("detailController", ["$scope", "$sce", "Kanjia",
function(t, e, o) {
    t.kanjia = new o;
    t.kanjia.loaddetail();
    t.trustAsHtml = function(t) {
        return e.trustAsHtml(t)
    }
}]);
app.factory("Record", ["$http",
function(t) {
    var e = function() {
        this.obj = {}
    };
    e.prototype.loadmykanjia = function() {
        t.get(KANJIA_MY_URL).success(function(t) {
            this.obj = t
        }.bind(this))
    };
    return e
}]);
app.controller("recordController", ["$rootScope", "$scope", "$http", "Record", "SweetAlert",
function(t, e, o, r, n) {
    e.helpstatus = false;
    e.record = new r;
    e.record.loadmykanjia();
    e.buy = function(t) {
        var e = KANJIA_BUY_URL;
        o.post(e, {
            id: t
        }).success(function(t) {
            if (t.errcode == 0) {
                n.swal({
                    title: "购买失败",
                    text: "亲，您又调皮了！",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (t.errcode == 1e4) {
                n.swal({
                    title: "购买失败",
                    text: "获取不到您的粉丝信息，请先关注我们吧~",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#F8BB86",
                    confirmButtonText: "关注",
                    closeOnConfirm: false,
                    cancelButtonText: "关闭",
                    animation: false
                },
                function(e) {
                    if (e) {
                        window.location.href = t.href
                    }
                })
            } else if (t.errcode == 10001) {
                n.swal({
                    title: "购买失败",
                    text: "亲，这不是您的砍价哦~",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (t.errcode == 10002) {
                n.swal({
                    title: "购买失败",
                    text: "亲，您已购买啦，我们会尽快处理售后的~",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (t.errcode == 10003) {
                n.swal({
                    title: "购买失败",
                    text: "亲，请在活动时间内购买~",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (t.errcode == 10004) {
                n.swal({
                    title: "购买失败",
                    text: "亲，您来晚了，已经抢购一空了~",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (t.errcode == 10005) {
                n.swal({
                    title: "购买失败",
                    text: "亲，您还没砍到底价呢~",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (t.errcode == 10006) {
                n.swal({
                    title: "未支付",
                    text: "亲，请您继续完成订单支付！",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#F8BB86",
                    confirmButtonText: "支付",
                    closeOnConfirm: false,
                    cancelButtonText: "关闭",
                    animation: false
                },
                function(e) {
                    if (e) {
                        window.location.href = t.href
                    }
                })
            } else if (t.errcode == 1) {
                window.location.href = t.href
            } else if (t.errcode == 2) {
                n.swal({
                    title: "人工处理",
                    text: "亲，请您通过下方的联系方式和客服沟通购买商品。~",
                    type: "success",
                    confirmButtonText: "确定"
                })
            } else {
                n.swal({
                    title: "未知错误",
                    text: "请稍后再试试~",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            }
        })
    };
    e.help = function(r) {
        var i = KANJIA_HELP_URL;
        o.post(i, {
            id: r
        }).success(function(o) {
            if (o.errcode == 0) {
                n.swal({
                    title: "帮砍失败",
                    text: "亲，您又调皮了！",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (o.errcode == 1e4) {
                n.swal({
                    title: "帮砍失败",
                    text: "获取不到您的粉丝信息，请先关注我们吧~",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "关注",
                    closeOnConfirm: false,
                    cancelButtonText: "关闭",
                    animation: false
                },
                function(t) {
                    if (t) {
                        window.location.href = o.href
                    }
                })
            } else if (o.errcode == 10001) {
                n.swal({
                    title: "帮砍失败",
                    text: "亲，您已帮该好友砍过了~",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (o.errcode == 10002) {
                n.swal({
                    title: "帮砍失败",
                    text: "亲，已经砍到底价了，再砍小编就要睡大街了~",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (o.errcode == 10004) {
                n.swal({
                    title: "帮砍失败",
                    text: "亲，为了防止刷活动同一IP只能帮砍" + o.ip_max + "次，请您明天再试试！",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (o.errcode == 10003) {
                n.swal({
                    title: "帮砍失败",
                    text: "亲，该活动您最多能帮砍" + o.helpcount + "次，已经帮砍了" + o.max_help + "！",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (o.errcode == 10005) {
                n.swal({
                    title: "帮砍失败",
                    text: "亲，感谢您拔刀相助，对方已购买该商品！",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (o.errcode == 10006) {
                n.swal({
                    title: "帮砍失败",
                    text: "亲，活动还未开始！",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (o.errcode == 10007) {
                n.swal({
                    title: "帮砍失败",
                    text: "亲，活动已结束了哦！",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else if (o.errcode == 1) {
                e.record.obj.price = parseFloat(e.record.obj.price) - parseFloat(o.price);
                e.record.obj.number_help = parseInt(e.record.obj.number_help) + 1;
                n.swal({
                    title: o.price + "元",
                    text: "亲，您的小刀一挥便砍了这么多~",
                    type: "success",
                    confirmButtonText: "确定"
                });
                t.$emit("addHelp", o.help)
            } else {
                n.swal({
                    title: "未知错误",
                    text: "请稍后再试试~",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            }
        })
    };
    e.needhelp = function() {
        e.helpstatus = true
    };
    e.closehelp = function() {
        e.helpstatus = false
    }
}]);
app.controller("helpController", ["$rootScope", "$scope", "$http",
function(t, e, o) {
    e.helplist = {};
    o.post(KANJIA_HELPLIST_URL, {
        rid: KANJIA_RECORD_ID
    }).success(function(t) {
        e.helplist.items = t
    });
    t.$on("addHelp",
    function(t, o) {
        e.helplist.items.unshift(o)
    })
}]);
app.controller("buyController", ["$scope", "$http", "SweetAlert",
function(t, e, o) {
    t.address = {};
    t.showAddress = false;
    t.pay = false;
    t.remark = "";
    t.weixinAddress = function () {
		wx.openAddress({
        success : function(res){
				//alert('获取地址成功！');
                //alert(JSON.stringify(res));
		        t.showAddress = true;
                t.address.name = res.userName;
                t.address.telnumber = res.telNumber;
                t.address.address = res.provinceName + res.cityName + res.countryName + res.detailInfo;
                t.$apply();         
        },
		fail: function (res) {
                alert('获取地址失败！');
       }
    });
}		
	/*function() {
        WeixinJSBridge.invoke("editAddress", ADDRESS_TOKEN,
        function(e) {
            if (e.err_msg == "edit_address:ok") {
                t.showAddress = true;
                t.address.name = e.userName;
                t.address.telnumber = e.telNumber;
                t.address.address = e.proviceFirstStageName + e.addressCitySecondStageName + e.addressCountiesThirdStageName + e.addressDetailInfo;
                t.$apply()
            } else {
                o.swal({
                    title: "获取地址失败",
                    text: "亲，请刷新后再试试~",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            }
        })
    };*/
    t.WechatPay = function(r) {
        if ((t.address.address == undefined || t.address.address == "") && KANJIA_QRCODE == 0) {
            o.swal({
                title: "支付失败",
                text: "亲，先选择好您的收货地址",
                type: "error",
                confirmButtonText: "关闭",
                confirmButtonColor: "#F27474"
            });
            return false
        }
        t.pay = true;
        e.post(KANJIA_UNIFIEDORDER_URL, {
            id: KANJIA_ORDER_ID
        }).success(function(n) {
            if (n.errcode != undefined) {
                if (n.errcode == 0) {
                    o.swal({
                        title: "支付失败",
                        text: "亲，该订单记录不存在哦~",
                        type: "error",
                        confirmButtonText: "关闭",
                        confirmButtonColor: "#F27474"
                    })
                } else if (n.errcode == 10001) {
                    o.swal({
                        title: "支付失败",
                        text: "亲，该订单已支付了哦~",
                        type: "error",
                        confirmButtonText: "关闭",
                        confirmButtonColor: "#F27474"
                    })
                } else if (n.errcode == 10002) {
                    o.swal({
                        title: "支付失败",
                        text: "亲，管理员忘记开启支付功能，联系下管理员呗~",
                        type: "error",
                        confirmButtonText: "关闭",
                        confirmButtonColor: "#F27474"
                    })
                } else if (n.errcode == 10003) {
                    o.swal({
                        title: "支付失败",
                        text: "亲，您来晚了，已经抢购一空了~",
                        type: "error",
                        confirmButtonText: "关闭",
                        confirmButtonColor: "#F27474"
                    })
                } else if (n.errcode == 10004) {
                    o.swal({
                        title: "支付失败",
                        text: "亲，下单失败，请稍后再试试~",
                        type: "error",
                        confirmButtonText: "关闭",
                        confirmButtonColor: "#F27474"
                    })
                } else if (n.errcode == 1) {
                    e.post(KANJIA_ORDER_UPDATE_URL, {
                        id: KANJIA_ORDER_ID,
                        remark: r,
                        address: t.address
                    }).success(function(e) {
                        t.pay = false;
                        if (e.errcode == 0) {
                            o.swal({
                                title: "砍价记录",
                                text: "亲，您确定该砍价记录是对的？",
                                type: "error",
                                confirmButtonText: "关闭",
                                confirmButtonColor: "#F27474"
                            })
                        } else if (e.errcode == 1) {
                            o.swal({
                                title: "支付成功",
                                text: "我们会尽快为您处理该订单。",
                                type: "success",
                                showCancelButton: false,
                                confirmButtonText: "确定",
                                closeOnConfirm: false,
                                animation: false
                            },
                            function(t) {
                                if (t) {
                                    window.location.href = KANJIA_URL
                                }
                            })
                        } else if (e.errcode == 10001) {
                            o.swal({
                                title: "支付失败",
                                text: "亲，您已下过单了，请不要再次下单啦~",
                                type: "error",
                                confirmButtonText: "关闭",
                                confirmButtonColor: "#F27474"
                            })
                        } else if (e.errcode == 10002) {
                            o.swal({
                                title: "支付失败",
                                text: "亲，修改订单时出错了，请联系管理员~",
                                type: "error",
                                confirmButtonText: "关闭",
                                confirmButtonColor: "#F27474"
                            })
                        } else {
                            o.swal({
                                title: "未知错误",
                                text: "请稍后再试试~",
                                type: "error",
                                confirmButtonText: "关闭",
                                confirmButtonColor: "#F27474"
                            })
                        }
                    })
                }
                t.pay = false;
                return false
            }
            wx.chooseWXPay({
                timestamp: n.timeStamp,
                nonceStr: n.nonceStr,
                "package": n.package,
                signType: n.signType,
                paySign: n.paySign,
                success: function(i) {
                    if (i.errMsg == "chooseWXPay:ok") {
                        e.post(KANJIA_ORDER_UPDATE_URL, {
                            id: KANJIA_ORDER_ID,
                            remark: r,
                            data: n,
                            address: t.address
                        }).success(function(e) {
                            t.pay = false;
                            if (e.errcode == 0) {
                                o.swal({
                                    title: "订单错误",
                                    text: "亲，您确定该订单记录是对的？",
                                    type: "error",
                                    confirmButtonText: "关闭",
                                    confirmButtonColor: "#F27474"
                                })
                            } else if (e.errcode == 1) {
                                o.swal({
                                    title: "支付成功",
                                    text: "我们会尽快为您处理该订单。",
                                    type: "success",
                                    showCancelButton: false,
                                    confirmButtonText: "确定",
                                    closeOnConfirm: false,
                                    animation: false
                                },
                                function(t) {
                                    if (t) {
                                        window.location.href = KANJIA_URL
                                    }
                                })
                            } else if (e.errcode == 10001) {
                                o.swal({
                                    title: "支付失败",
                                    text: "亲，您已下过单了，请不要再次下单啦~",
                                    type: "error",
                                    confirmButtonText: "关闭",
                                    confirmButtonColor: "#F27474"
                                })
                            } else if (e.errcode == 10002) {
                                o.swal({
                                    title: "支付失败",
                                    text: "亲，保存订单时出错了，请联系管理员~",
                                    type: "error",
                                    confirmButtonText: "关闭",
                                    confirmButtonColor: "#F27474"
                                })
                            } else {
                                o.swal({
                                    title: "未知错误",
                                    text: "请稍后再试试~",
                                    type: "error",
                                    confirmButtonText: "关闭",
                                    confirmButtonColor: "#F27474"
                                })
                            }
                        })
                    } else {
                        t.pay = false
                    }
                },
                fail: function(e) {
                    t.pay = false;
                    o.swal({
                        title: "支付失败",
                        text: "请稍后再试试~",
                        type: "error",
                        confirmButtonText: "关闭",
                        confirmButtonColor: "#F27474"
                    })
                },
                cancel: function() {
                    t.pay = false;
                    t.$apply()
                }
            })
        })
    }
}]);
app.factory("TopReddit", ["$rootScope", "$http",
function(t, e) {
    var o = function() {
        this.items = [];
        this.load = false;
        this.page = 1;
        this.last = false
    };
    o.prototype.nextPage = function() {
        if (this.load || this.last) return;
        this.load = true;
        var o = KANJIA_TOP_URL;
        e.post(o, {
            page: this.page,
            id: KANJIA_ID
        }).success(function(e) {
            for (var o = 0; o < e.length; o++) {
                this.items.push(e[o])
            }
            this.page += 1;
            this.load = false;
            if (e.length <= 0) {
                this.last = true
            }
            t.$broadcast("pageload-hide", true)
        }.bind(this))
    };
    return o
}]);
app.controller("topController", ["$scope", "TopReddit",
function(t, e) {
    t.topreddit = new e
}]);
app.factory("MyjoinReddit", ["$rootScope", "$http",
function(t, e) {
    var o = function() {
        this.items = [];
        this.load = false;
        this.page = 1;
        this.last = false
    };
    o.prototype.nextPage = function() {
        if (this.load || this.last) return;
        this.load = true;
        var o = KANJIA_MYJOIN_URL;
        e.post(o, {
            page: this.page
        }).success(function(e) {
            for (var o = 0; o < e.length; o++) {
                this.items.push(e[o])
            }
            this.page += 1;
            this.load = false;
            if (e.length <= 0) {
                this.last = true
            }
            t.$broadcast("pageload-hide", true)
        }.bind(this))
    };
    return o
}]);
app.controller("myjoinController", ["$scope", "MyjoinReddit",
function(t, e) {
    t.myjoinreddit = new e
}]);
app.controller("qrController", ["$rootScope", "$scope", "$http", "SweetAlert",
function(t, e, o, r) {
    e.password = "";
    e.check = function() {
        o.post(KANJIA_QRAJAX_URL, {
            password: e.password
        }).then(function(t) {
            if (t.data.errcode == 1) {
                r.swal({
                    title: "校验成功",
                    text: "请点击确定",
                    type: "success",
                    confirmButtonText: "确定"
                },
                function(t) {
                    window.location.reload()
                })
            } else if (t.data.errcode == 10001) {
                r.swal({
                    title: "校验失败",
                    text: "校验码错误！",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            } else {
                r.swal({
                    title: "校验失败",
                    text: "请稍后再试试~",
                    type: "error",
                    confirmButtonText: "关闭",
                    confirmButtonColor: "#F27474"
                })
            }
        },
        function(t) {
            r.swal({
                title: "校验失败",
                text: "请稍后再试试~",
                type: "error",
                confirmButtonText: "关闭",
                confirmButtonColor: "#F27474"
            })
        })
    };
    e.saoma = function() {
        wx.scanQRCode({
            needResult: 1,
            scanType: ["qrCode", "barCode"],
            success: function(t) {
                if (t.errMsg == "scanQRCode:ok") {
                    o.post(KANJIA_SAOMA_URL, {
                        qrcode: t.resultStr
                    }).then(function(t) {
                        if (t.data.errcode == 10001) {
                            r.swal({
                                title: "扫码失败",
                                text: "无效二维码！",
                                type: "error",
                                confirmButtonText: "关闭",
                                confirmButtonColor: "#F27474"
                            })
                        } else if (t.data.errcode == 10002) {
                            r.swal({
                                title: "扫码失败",
                                text: "该凭证在" + t.data.usetime + "被核销！",
                                type: "error",
                                confirmButtonText: "关闭",
                                confirmButtonColor: "#F27474"
                            })
                        } else if (t.data.errcode == 10003) {
                            r.swal({
                                title: "扫码失败",
                                text: "请稍后再试试~",
                                type: "error",
                                confirmButtonText: "关闭",
                                confirmButtonColor: "#F27474"
                            })
                        } else if (t.data.errcode == 1) {
                            r.swal({
                                title: "扫码成功",
                                text: "该二维码已被您核销！",
                                type: "success",
                                confirmButtonText: "确定"
                            })
                        } else {
                            r.swal({
                                title: "扫码失败",
                                text: "请稍后再试试~",
                                type: "error",
                                confirmButtonText: "关闭",
                                confirmButtonColor: "#F27474"
                            })
                        }
                    },
                    function(t) {
                        r.swal({
                            title: "扫码失败",
                            text: "请稍后再试试~",
                            type: "error",
                            confirmButtonText: "关闭",
                            confirmButtonColor: "#F27474"
                        })
                    })
                } else {
                    r.swal({
                        title: "扫码失败",
                        text: "请稍后再试试~",
                        type: "error",
                        confirmButtonText: "关闭",
                        confirmButtonColor: "#F27474"
                    })
                }
            }
        })
    };
    t.$broadcast("pageload-hide", true)
}]);